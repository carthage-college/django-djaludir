{% extends "core/home.html" %}
{% block title %}Search &mdash; {{block.super}}{% endblock %}
{% block extra_style %}
    {{block.super}}
    <link rel="stylesheet" href="/mkishline/static/djaludir/css/tablesorter_theme/blue/style.css" />
    <style type="text/css">
        .center {text-align:center;font-size:14px;font-weight:bold;}
        
        #searchResults {padding:3px 5px;}
        
        th.headerSortUp {
            /* background-image: url('/mkishline/static/djaludir/css/tablesorter_theme/blue/asc.gif');
            background-color: #3399FF; */
            background: url('/mkishline/static/djaludir/css/tablesorter_theme/blue/asc.gif') no-repeat #3399FF;
        }
    </style>
{% endblock %}
{% block extra_javascript %}
    <script type="text/javascript" src="/mkishline/static/djaludir/js/commonLib.js"></script>
    <script type="text/javascript" src="/mkishline/static/djaludir/js/jquery.tablesorter.min.js"></script>
    <script type="text/javascript">
        var MAX_CRITERIA = 5;
        var criteria = 0;
        var SELECT_VALUES = 'ids.firstname^First Name,ids.lastname^Last Name,alum.cl_yr^Class year,home_state^Home State,home_city^Home City,ids.id^ID Number,maiden.lastname^Maiden Name,activity^Activity/Sport,major1.txt^Primary Major,major2.txt^Secondary Major,job_title^Job Title';

        function updateCriteria(){
            criteria = $('#formfieldset div.search').length;
            $('input[name="maxCriteria"]').val(criteria);
        }

        function createBlock(fieldName, searchTerm){
            if (fieldName === undefined || fieldName == null) fieldName = '';
            if (searchTerm === undefined || searchTerm == null) searchTerm = '';
            
            if(criteria < MAX_CRITERIA){
                var $divObj = $('<div>').addClass('form-row').addClass('search');
                $('<select>').attr('name','within' + criteria).appendTo($divObj);

                $('<span> contains </span>').appendTo($divObj);
                $('<input>').attr('type','text').attr('name','term' + criteria).attr('size','15').val(searchTerm).appendTo($divObj);

                if(criteria < MAX_CRITERIA - 1){
                    $('<span>&nbsp;</span>').appendTo($divObj);
                    $('<input>').attr('type','button').attr('name','add_search').val('ADD').click(createBlock).appendTo($divObj);
                }
                
                $('#submitrow').before($divObj);
                clearSelect('select[name="within' + criteria + '"]');
                loadSelectKeyVal('select[name="within' + criteria + '"]', SELECT_VALUES, false);
                $('select[name="within' + criteria + '"]').val(fieldName);

                updateCriteria();

                if(criteria > 1){
                    $('<a>').attr('name','delete').text(' X ').click(deleteBlock).appendTo($divObj);
                }
            }
        }
        
        function deleteBlock(){
            $(this).parent('.form-row').remove();
            var curRow = 1;
            $('#formfieldset div.search').each(function(){
                $(this).find('select[name^="within"]').attr('name','within' + curRow);
                $(this).find('input[name^="term"]').attr('name','term' + curRow);
                if($(this).find('input[name="add_search"]').length == 0){
                    var $deleteObj = $(this).find('a[name="delete"]');
                    $('<span>&nbsp;</span>').insertBefore($deleteObj);
                    $('<input>').attr('type','button').attr('name','add_search').val('ADD').click(createBlock).insertBefore($deleteObj);
                }
                curRow++;
            });
            updateCriteria();
        }
        
        $(document).ready(function(){
            $('#searchResults').tablesorter({
                headers: {
                    3: { sorter:false },
                    4: { sorter:false }
                }
            });
            
            $('form[name="searchForm"]').submit(function(){
                var validForm = false;
                $('#formfieldset div.search input[name^="term"]').each(function(){
                    if($(this).val() != ''){
                        validForm = true;
                    }
                });
                return validForm;
            })
            
            updateCriteria();
            {% if searching %}
                {% for field, term in searching.items %}
                    createBlock('{{field}}','{{term}}');
                {% endfor %}
            {% else %}
                createBlock();
            {% endif %}
        });
    </script>
{% endblock %}
{% block content %}
    {% if message %}<div class="message">{{message}}</div>{% endif %}
    <p>Search:</p>
    <form action="." name="searchForm" method="post">
        <input type="hidden" name="maxCriteria" value="0" />
        {% csrf_token %}
        <fieldset id="formfieldset">
            <div id="submitrow" class="form-row">
                <input type="submit" name="submit" value="Search" />
            </div>
        </fieldset>
    </form>

    {% if matches %}
    <h3>{{matches|length}} match{{matches|length|pluralize:"es"}}</h3>
    <table id="searchResults" class="tablesorter">
        <thead>
            <tr><th>Class Year</th><th>First Name</th><th>Last Name</th><th>Deceased</th><th>Action</th></tr>
        </thead>
        <tbody>
            {% for person in matches %}
                <tr>
                    <td>{{person.class_year}}</td>
                    <td>{{person.firstname}}</td>
                    <td>{% if person.maiden_name %}({{person.maiden_name}}) {% endif %}{{person.lastname}}</td>
                    <td>{% comment %}{% if person.is_deceased %}deceased{% endif %}{% endcomment %}</td>
                    <td><a href="../display/{{person.id}}/">Details</a>
                        {% if session.is_superuser %} &nbsp; <a href="../edit/{{person.id}}">Edit</a>{% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if debug %}
        {{debug}}
    {% endif %}
{% endblock %}